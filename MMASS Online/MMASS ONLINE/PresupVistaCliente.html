<!DOCTYPE html>
<html>
<head runat="server">
    <title>MMASS Online - Presupuesto de Venta</title>

    <link rel="shortcut icon" href="favicon.png">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.1/js/tempusdominus-bootstrap-4.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.0.0-alpha14/css/tempusdominus-bootstrap-4.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400&display=swap" rel="stylesheet">
    <script src="./js/autentificar.js"></script>
    <script src="./js/export.js"></script>
    <script src="./js/filedownloader.js"></script>
    <script src="./js/html2pdf.js"></script>
    <script src="./dist/duallistbox/jquery.bootstrap-duallistbox.min.js"></script>
    <link href="./dist/duallistbox/bootstrap-duallistbox.min.css" rel="stylesheet">


    <style>
        .search-box-closed {
            width: 53px;
        }

        @media print {
            .col-lg-1, .col-lg-2, .col-lg-3, .col-lg-4, .col-lg-5, .col-lg-6, .col-lg-7, .col-lg-8, .col-lg-9, .col-lg-10, .col-lg-11, .col-lg-12 {
                float: left;
            }

            .actions {
                display: none;
            }

            .col-lg-12 {
                width: 100%;
            }

            .col-lg-11 {
                width: 91.66666667%;
            }

            .col-lg-10 {
                width: 83.33333333%;
            }

            .col-lg-9 {
                width: 75%;
            }

            .col-lg-8 {
                width: 66.66666667%;
            }

            .col-lg-7 {
                width: 58.33333333%;
            }

            .col-lg-6 {
                width: 50%;
            }

            .col-lg-5 {
                width: 41.66666667%;
            }

            .col-lg-4 {
                width: 33.33333333%;
            }

            .col-lg-3 {
                width: 25%;
            }

            .col-lg-2 {
                width: 16.66666667%;
            }

            .col-lg-1 {
                width: 8.33333333%;
            }
        }

        @media (max-width: 767px) {
            .search-box-open {
                width: 100%;
            }

            #divMessage {
                position: fixed;
                width: 100%;
                bottom: 2px;
                text-align: center;
            }
        }

        @media (min-width: 768px) {
            .search-box-open {
                width: 300px;
            }
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1150px;
            }
        }

        @media (min-width: 1400px) {
            .container {
                max-width: 1200px;
            }
        }

        @media (min-width: 1600px) {
            .container {
                max-width: 1400px;
            }
        }

        .input-group-addon {
            padding: 5px;
            background: #b3c1cc;
        }

        @media screen {

            #divMessage {
                position: fixed;
                left: 50%;
                margin-left: -200px;
                width: 400px;
                bottom: 30px;
                text-align: center;
            }
        }

        ::-webkit-file-upload-button {
            padding: .2rem .3rem;
            color: #fff;
            background-color: #343a40;
            border-color: #343a40;
            font-size: .875rem;
            line-height: 1.5;
            border-radius: .2rem;
            cursor: pointer;
        }

        .mb-6 {
            margin-bottom: 3rem;
        }

        button > a {
            color: #383b3e;
        }

            button > a:hover {
                color: #fff;
            }

        .nav > a {
            color: #17a2b8;
        }

            .nav > a:hover {
                color: #138496;
            }

        .table td {
            border-top: 0;
        }

        td:first-child {
            border-top-left-radius: .5rem;
            border-bottom-left-radius: .5rem;
        }

        td:last-child {
            border-bottom-right-radius: .5rem;
            border-top-right-radius: .5rem;
        }

        .invisible {
            color: #e9ecef;
        }

        /* Icon pulse */
        .fa-pulse {
            display: inline-block;
            -moz-animation: pulse 2s infinite linear;
            -o-animation: pulse 2s infinite linear;
            -webkit-animation: pulse 2s infinite linear;
            animation: pulse 2s infinite linear;
        }

        @-webkit-keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        @-moz-keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        @-o-keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        @-ms-keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        .tableFixHead {
            overflow-y: auto;
            height: 500px;
        }

            .tableFixHead thead th {
                position: sticky;
                top: 0;
            }

        .list-group-item {
            padding: .2rem 1rem;
        }

        .modalConv {
            max-width: none;
            width: 90%;
            height: 60%;
            /*overflow-y: auto;*/
        }

        .btn-blue {
            background-color: #d1ecf1;
        }

        .btn-danger {
            color: #fff;
            background-color: #fc9a00;
            border-color: #fc9a00
        }

            .btn-danger:hover {
                color: #fff;
                background-color: #e08902;
                border-color: #e08902
            }

        .dataTitle {
            font-family: 'Roboto';
            font-size: 20px;
        }

        .jumbotron {
            background-color: #f5f5f5 !important;
        }

        .rounded {
            border-radius: 1.5rem !important;
        }

        .navbar {
            padding: 0 1rem;
            position: fixed;
            top: 0;
            width: 100%;
        }

            .navbar li {
                text-align: center;
            }

        .shadow {
            box-shadow: 0 .9rem 1rem rgba(0,0,0,.40) !important;
        }
    </style>

    <script>
        //FUNCIONES PARA DESLOGUEARSE AL SALIR DE LA PAGINA (POR SEGURIDAD) 
        // Function to change the content of t2
        function modifyText(new_text) {
            var t2 = document.getElementById("t2");
            t2.firstChild.nodeValue = new_text;
        }

        // Function to add event listener to t
        function load() {
            var el = document.getElementById("t");
            el.addEventListener("click", function () { modifyText("four") }, false);
        }

        let formChanged = false;
        document.addEventListener('change', () => formChanged = true);
        window.addEventListener('beforeunload', (event) => {
            sessionStorage.setItem('token', "Bearer " + "");
            if (formChanged) {
                event.returnValue = '';
            }
            else {
                wait(200);
            }
        });

    </script>

</head>

<body style="padding-top: 80px; font-family: 'Roboto';">
    <!--MENU-->
    <div id="divNavBar">
        <nav class="navbar navbar-expand-lg navbar-dark sticky-top bg-dark shadow">
            <a class="navbar-brand" id="navBarLogo">
                <img src="/img/logoMmassOnlineFO.svg" width="120" height="35" class="d-inline-block align-top" alt="">
                <!--MMASS Online-->
            </a>
        </nav>
    </div>

    <!--CONTENEDOR PRINCIPAL HTML-->
    <main role="main" class="container">
        <div id="divBlock" style="left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        overflow-x: hidden;
        overflow-y: auto;
        position: fixed;
        z-index: 1051;
        outline: 0;
        display: none"></div>

        <!-- Modal Progress bar -->
        <div class="modal " id="pleaseWaitDialog" data-backdrop="static" data-keyboard="false" style="        display: none
">
            <div class="modal-dialog" role="document">
                <div class="modal-content shadow p-3 mb-5 bg-white rounded">
                    <div class="modal-header">
                        <h4 class="modal-title" onclick='hidePleaseWait();'>Procesando...</h4>
                    </div>
                    <div class="modal-body">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">

                            </div>
                        </div>
                    </div>
                </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div>

        <!-- Modal Mensajes -->
        <div class="modal fade" id="modalCenter" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content shadow p-3 mb-5 bg-white rounded">
                    <div class="modal-header d-flex justify-content-center">
                        <h5 class="modal-title" id="modalCenterTitle">Advertencia</h5>
                    </div>
                    <div class="modal-body" id="modalCenterBody">

                    </div>
                    <div class="modal-footer d-flex justify-content-center" id="modalCenterFooter">

                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="largeModal">

            <div class="modal-dialog modal-xl">
                <div class="modal-content shadow p-3 mb-5 bg-white rounded">

                    <!-- Modal Header -->
                    <div class="modal-header">
                        <h4 class="modal-title" id="largeModalTitle"></h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>

                    <!-- Modal body -->
                    <div class="modal-body" id="largeModalBody">

                    </div>

                    <!-- Modal footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Modal RON -->
        <div class="modal fade" id="modalRon" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content shadow p-3 mb-5 bg-white rounded">
                    <div class="modal-header d-flex justify-content-center">
                        <h5 class="modal-title">% Formas de Pago</h5>
                    </div>
                    <div class="modal-body" id="modalRonBody">

                    </div>
                    <div class="modal-footer d-flex justify-content-center" id="modalRonFooter">

                    </div>
                </div>
            </div>
        </div>

        <!--Modal Cotizacion Moneda-->
        <div class="modal fade" id="cotizacionModal" tabindex="-1" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content shadow p-3 mb-5 bg-white rounded" style="width: 634px;">

                    <!-- Modal Header -->
                    <div class="modal-header d-flex justify-content-center">
                        <h4 class="modal-title" id="cotizacionModalTitle">COTIZACIONES DE MONEDAS</h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>

                    <!-- Modal body -->
                    <div class="modal-body" id="cotizacionModalBody">
                        <!--Tabla-->
                        <div class="table-responsive mt-2 tableFixHead" style="height: 300px; width: 500px;">
                            <table class="table table-fixed table-striped" id="tCotizaciones">
                                <thead class="thead-dark">
                                    <tr>
                                        <th class="col-xs-2" style="text-align: center;">Moneda</th>
                                        <th class="col-xs-2" style="text-align: center;">Cotización</th>
                                        <!--<th class="col-xs-1" style="text-align: center;">Venta</th>-->
                                        <th class="col-xs-1" style="text-align: center;">Ultima actualización</th>
                                    </tr>
                                </thead>
                                <tbody id="TableCotizaciones"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Modal footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
                    </div>

                </div>
            </div>
        </div>

        <!-- PRINCIPAL -->
        <div id="divMessage" class="alert" style="display:none;cursor:pointer;z-index:10000;" title="Click para cerrar"> </div>
        <div class="jumbotron mt-4 py-4 shadow p-3 mb-5 bg-white rounded">
            <div class=" d-flex align-items-center" style="margin-bottom: 1rem;">
                <span class="dataTitle" id="pTitulo" style="margin-right: 15px;">PRESUPUESTO DE VENTA</span>
                <!--<div id="divAnuClon">
            </div>-->
            </div>
            <!-- TABS -->
            <!--<nav class="nav nav-tabs mb-3">
            <a class="nav-link active" id="principal-tab" data-toggle="tab" href="#principal" role="tab" aria-controls="principal" aria-selected="true">General</a>
            <a class="nav-link" id="archivos-tab" data-toggle="tab" href="#archivos" role="tab" aria-controls="archivos" aria-selected="false">Certificación</a>
        </nav>-->
            <!--<div class="tab-content" id="tabsContent">-->
            <div class="tab-pane fade show active" id="principal" role="tabpanel" aria-labelledby="principal-tab">
                <!--ORDER DATA-->
                <div id="divOrderData">
                    <!-- GRUPO 1 -->
                    <div id="grupo1">
                        <div class="row">
                            <div class="col-lg-4">
                                <label>Número de Presupuesto</label>
                                <div id="PresupuestoNumberComplete" class="row">
                                    <div class="col-lg-4 "> <div class="input-group"> <input type="text" disabled id="inpOrderYear" class="form-control" value=""></div> </div>
                                    <div class="col-lg-4 "> <div class="input-group"> <input type="text" disabled id="inpOrderMonth" class="form-control" value=""> </div> </div>
                                    <div class="col-lg-4 "> <div class="input-group"> <input type="text" disabled class="form-control" id="inpOrderNumber" id_op_dg="0"> </div> </div>
                                </div>
                            </div>
                            <div class="col-lg-3" style="padding-right: 0px;">
                                <label>Moneda</label>
                                <select class="form-control" id="selMoneda" onfocus="this.oldvalue = this.value" onchange="cambiarMoneda(this); this.oldvalue = this.value;" disabled></select>
                            </div>
                            <div class="col-lg-1" style="padding-top: 4px;">
                                <label for="bCambioMoneda" class="invisible">Cambios</label>
                                <button type="button" data-id="cambioMoneda" id="bCambioMoneda" class="btn actions btn-outline-dark btn-sm mr-1 btn-block" onclick="getCotizaciones()" title="Ver cotizaciones de monedas">
                                    <span class="fa fa-usd"></span>
                                    <span class="fa fa-exchange"></span>
                                    <span class="fa fa-eur"></span>
                                </button>
                            </div>
                            <div class="col-lg-4">
                                <div class="row">
                                    <div class="col-lg-6">
                                        <label>Fecha Alta</label>
                                        <div class="input-group"> <input type="text" disabled id="inpFechaAlta" class="form-control  col text-center" value=""> </div>
                                    </div>
                                    <div class="col-lg-6">
                                        <label>Estado</label>
                                        <div class="input-group">
                                            <input type="text" disabled id="inpEstado" class="form-control col text-center" style="background-color: #343a40;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <!-- GRUPO 2 -->
                        <!-- FILA 1 -->
                        <div class="row justify-content-around" style="padding-top: 15px;">
                            <div class="col-lg-4">
                                <label>Vigencia Presupuesto</label>
                                <div id="OrderDateSpam" class="row">
                                    <div class="col-lg-12">
                                        <div class="input-group input-daterange">
                                            <input type="text" class="form-control datetimepicker-input" id="fechaDesde" data-toggle="datetimepicker" data-target="#fechaDesde" disabled />
                                            <span class="input-group-addon">hasta</span>
                                            <input type="text" class="form-control datetimepicker-input" autocomplete="off" id="fechaHasta" data-toggle="datetimepicker" data-target="#fechaHasta" disabled />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <label>Descripción</label>
                                <div class="input-group"> <input type="text" id="inpDescOP" class="form-control" disabled> </div>
                            </div>
                            <div class="col-lg-4">
                                <label>Concepto de Negocio</label>
                                <select class="form-control" id="selConceptoN" disabled></select>
                            </div>
                        </div>
                        <!-- FILA 2 -->
                        <!-- GRUPO 2 -->
                        <hr>
                        <div class="row">
                            <div class="col-lg-4">
                                <label>Agencia</label>
                                <select class="form-control" id="selAgencia" onchange="onAgenciaSelected()" disabled></select>
                            </div>
                            <div class="col-lg-4">
                                <label>Anunciante</label>
                                <select class="form-control" id="selAnunciante" onchange="onAnuncianteSelected()" disabled></select>
                            </div>
                            <div class="col-lg-4">
                                <label>Producto</label>
                                <select class="form-control" id="selProducto" onchange="onProductoSelected()" disabled></select>
                            </div>
                        </div>
                        <!--<div class="row mt-2">
                        <div class="col-lg-2 offset-lg-10 d-flex justify-content-end">
                            <button id="botLimpiar" title="Limpiar Agencia - Anunciante" type="button" class="btn actions btn-outline-dark btn-sm mr-1" onclick="limpiaVinculados();">
                                <span class="fa fa-eraser"></span> Limpiar
                            </button>
                        </div>
                    </div>-->
                    </div>
                    <hr>
                    <div class="row" style="padding-top: 15px;">
                        <div class="col-lg-6" style="padding-right: 20px;">
                            <div class="row" style="padding-left: 15px; padding-right: 15px;">
                                <label>Facturar a</label>
                                <select class="form-control" id="selFacturar" disabled>
                                    <option value="0" checked>Agencia</option>
                                    <option value="1">Anunciante</option>
                                    <option value="2">No facturar</option>
                                </select>
                            </div>
                            <div class="row" style="padding-left: 15px; padding-right: 15px; padding-top: 15px;">
                                <label>Plazo de Pago</label>
                                <select class="form-control" id="selPlazoP" disabled></select>
                            </div>
                            <div class="row" style="padding-left: 15px; padding-right: 15px; padding-top: 15px;">
                                <label>Ejecutivo</label>
                                <select class="form-control" id="selEjecutivo" disabled></select>
                            </div>
                        </div>
                        <div class="col-lg-6" style="padding-left: 20px;">
                            <div class="row" style="padding-left: 15px; padding-right: 15px;">
                                <label for="selFPago" style="margin-bottom: 0px;">Subtipo de Venta</label>
                                <select id="selFPago" class="custom-select" onchange="$('#porcRon').empty(); enableRon();" multiple></select>
                            </div>
                            <div class="row" style="padding-left: 15px; padding-right: 15px; padding-top: 13px;">
                                <button type="button" id="botPorcRon" class="btn actions btn-outline-dark" style="flex-grow: 1;" onclick="openRonPorc();">
                                    <span class="fa fa-pie-chart"></span> Porcentajes
                                </button>
                                <div id="porcRon" style="display:none"></div>
                            </div>
                        </div>
                    </div>

                    <!--ORDER DETAILS-->
                    <hr>
                    <div id="divOrderDetail" class="mt-2">

                        <div id="divDetailsRows">

                            <div class="row">
                                <div class="col-lg-1">
                                    <label>DETALLES</label>
                                </div>
                                <!--<div class="col-lg-2">
                                <button type="button" class="btn  actions btn-outline-dark btn-sm" id="bCargarNuevoRenglon" onclick="cargarNuevoRenglon()" title="Nuevo Detalle" style="padding-top: 2px; padding-bottom: 2px; margin-right: 10px; padding-right: 10px; padding-left: 10px;">
                                    <span class="fa fa-plus"></span>
                                </button>
                            </div>-->
                                <div class="col-lg-6">
                                </div>
                            </div>

                            <div class="table-responsive mt-2">
                                <table class="table table-fixed" id="tReng" style="text-align: center;">
                                    <thead>
                                        <tr>
                                            <th class="col-xs-3">Programa/Rango horario</th>
                                            <th class="col-xs-2">Vigencia</th>
                                            <th class="col-xs-2">T. Aviso</th>
                                            <th class="col-xs-1">Tarifa</th>
                                            <th class="col-xs-1">Cant.</th>
                                            <th class="col-xs-1">Neto</th>
                                            <th class="col-xs-2 actions" style="text-align:center;">Acciones</th>
                                            <th width="1px"></th>
                                            <th width="1px"></th>
                                            <th width="1px"></th>
                                            <th width="1px"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="TableRenglones"></tbody>
                                </table>
                            </div>
                        </div>


                        <div id="divAddRow" class="card" style="display:none;">
                            <div class="card-header d-flex" id="chDetalle">
                                <!--NUEVO DETALLE-->
                                <span class="dataTitle" id="pTituloDetalle" style="margin-right: 15px;">NUEVO DETALLE</span>
                                <div id="divClonDet">
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-lg-3">
                                        <label>Medio</label>
                                        <select class="form-control" id="selMediosD" onchange="filterTarifas(); filterProgramas()" disabled></select>
                                    </div>
                                    <div class="col-lg-3">
                                        <label>Tarifa</label>
                                        <select class="form-control" id="selTarifaD" onchange="filterPorTarifa()" disabled></select>
                                        <div class="row float-right">
                                            <div class="form-check-inline mr-0">
                                                <label class="form-check-label " for="checkTarifaManualD" style="padding-right: 15px;">
                                                    <input type="checkbox" style="margin-top: .4rem; margin-right: .2rem" class="form-check-input float-sm-left" id="checkTarifaManualD" disabled>Manual
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3">
                                        <label>Ambito</label>
                                        <select class="form-control" id="selAmbito" disabled>
                                            <option value="0"></option>
                                            <option value="1">Local</option>
                                            <option value="2">Nacional</option>
                                        </select>
                                    </div>
                                    <div class="col-lg-3">
                                        <label>Vigencia</label>
                                        <div class="input-group input-daterange" disabled>
                                            <input type="datetime" class="form-control" id="fechaDesdeD" data-toggle="datetimepicker" data-target="#fechaDesdeD" onchange="calcularNetoD();" />
                                            <span class="input-group-addon">hasta</span>
                                            <input type="datetime" class="form-control" id="fechaHastaD" data-toggle="datetimepicker" data-target="#fechaHastaD" onchange="calcularNetoD();" />
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-3">
                                        <label>Forma de Uso</label>
                                        <select class="form-control" id="selTipoTarifaD" disabled></select>
                                    </div>
                                    <div class="col-lg-3">
                                        <label>Tipo Aviso</label>
                                        <select class="form-control" id="selTipoAvisoD" disabled></select>
                                    </div>
                                    <div class="col-lg-3">
                                        <label>Programa</label>
                                        <select class="form-control" id="selPrograma" disabled></select>
                                    </div>
                                    <div class="col-lg-3">
                                        <label>Rango Horario</label>
                                        <div class="input-group input-daterange" disabled>
                                            <input type="time" id="rangoDesde" class="form-control">
                                            <span class="input-group-addon">hasta</span>
                                            <input type="time" id="rangoHasta" class="form-control">
                                        </div>
                                    </div>
                                </div>
                                <div class="row" style="padding-top: 40px;">
                                    <div class="col-lg-2">
                                        <label>Precio Unitario</label>
                                        <div id="divPrecioUnitarioD">
                                            <input type="number" id="precioUnitarioD" class="form-control" readonly="readonly" onchange="calcularNetoD()">
                                        </div>
                                    </div>
                                    <div class="col-lg-2">
                                        <label id="cantidadL">Cantidad</label>
                                        <div id="divCantD">
                                            <input type="number" id="cantidadD" class="form-control" onchange="calcularNetoD()" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-2">
                                        <label>% Descuento</label>
                                        <div id="divDescuentoD">
                                            <input type="number" id="descuentoD" class="form-control" onchange="calcularNetoD()" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-2">
                                        <label>Total</label>
                                        <div id="divTotalD">
                                            <input type="text" id="totalD" readonly="readonly" class="form-control">
                                        </div>
                                    </div>
                                    <div class="col-lg-2">
                                        <label>% NC</label>
                                        <div id="divConfNCD">
                                            <input type="number" id="confNCD" class="form-control" disabled>
                                        </div>
                                    </div>
                                    <div class="col-lg-2">
                                        <label>% FC</label>
                                        <div id="divConfFCD">
                                            <input type="number" id="confFCD" class="form-control" disabled>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer mt-2 ">
                                <div class="row">
                                    <div class="col-lg-4">
                                    </div>
                                    <div class="col-lg-4"></div>
                                    <div class="col-lg-4 d-flex justify-content-end">
                                        <button type="button" class="btn btn-dark btn-sm mx-1" onclick="cancelarCargaDetalle();">
                                            Cerrar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr>
                    <!--TOTALES-->
                    <div class="container-fluid small">
                        <div class="row">
                            <div class="col-sm">
                                <label>Bruto</label>
                                <input type="number" class="form-control" id="montoBruto" readonly="readonly" value="0">
                            </div>
                            <div class="col-sm">
                                <label>% Desc</label>
                                <input type="number" class="form-control" value="0" readonly="readonly" id="porc_desc">
                            </div>
                            <div class="col-sm">
                                <label>Primer Neto</label>
                                <input type="number" class="form-control" value="0" readonly="readonly" id="neto1">
                            </div>      <div class="col-sm">
                                <label>Conf NC</label>
                                <input type="number" class="form-control" value="0" id="conf_nc" onchange="calculateTotals()" disabled="disabled">
                            </div>
                            <div class="col-sm">
                                <label>Conf FC</label>
                                <input type="number" class="form-control" value="0" id="conf_fc" onchange="calculateTotals()" disabled="disabled">
                            </div>
                            <div class="col-sm">
                                <label>Seg Neto</label>
                                <input type="number" class="form-control" value="0" readonly="readonly" id="neto2">
                            </div>

                            <div class="col-sm">
                                <!--<label>Total (+IVA)</label>-->
                                <label>Total</label>
                                <input type="number" class="form-control" value="0" readonly="readonly" id="total">
                            </div>
                        </div>
                    </div>

                    <div class="card-footer mt-2 ">
                        <div class="row d-flex justify-content-center">
                            <button type="button" id="bAceptarPresup" class="btn actions btn-dark mx-1" style="width: 126px;height: 44px;margin-right: 40px;" onclick="savePresup(2)">
                                <span class="fa fa-check" style="color: lawngreen;"></span> Aceptar
                            </button>
                            <button type="button" id="bRechazarPresup" class="btn actions btn-dark mx-1" style="width: 126px;height: 44px;margin-right: 40px;" onclick="savePresup(4)">
                                <span class="fa fa-remove" style="color: red;"></span> Rechazar
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!--Scripts-->
    <script type="text/javascript">

        var cMultiSelect = $('.custom-select').bootstrapDualListbox({
            filterPlaceHolder: 'Filtrar',
            removeAllLabel: 'Remove all'
        });
        $(".moveall").hide();
        $(".removeall").hide();
        $(".btn-group").hide();
        $(".bootstrap-duallistbox-container").css("flex-grow", "1");

        var body = document.getElementById("output");

        callWS("users", "authenticateClientePresup", '{"username": "cliente","password": "123"}', function (data) { onAutentificarClientePresup(data); })

        $('#modalCenter').on('hidden.bs.modal', function (e) {
            $('#ronTableBody').empty();
        })

        $(".bootstrap-duallistbox-container").find("*").prop("disabled", true);

        $("input[type=number]").attr("onkeydown", "return event.keyCode !== 69 && event.keyCode !== 109");
        $("input[type=number]").attr("min", "0");

        $("#checkTarifaManualD").change(function () {

            $("#precioUnitarioD").prop("readonly", !$(this).is(":checked"));
            onTarifaDSelected();
        });
        document.body.style.backgroundImage = "url(./fondoM3.png)";


        function onAutentificarClientePresup(data) {
            sessionStorage.setItem('token', "Bearer " + data.token);
            sessionStorage.setItem('userId', data.id);
            sessionStorage.setItem('userName', data.firstName);
            sessionStorage.setItem('userRol', data.usrrol);

            inicializar();
        }


        function inicializar() {
            $('#fechaDesde').datetimepicker({ format: 'L', locale: 'es' });
            $('#fechaHasta').datetimepicker({ format: 'L', locale: 'es' });

            $("#divMessage").on("click", function () { $("#divMessage").hide(); });
            $.when(
                callWS("contactos", "getAgencias", '', function (data) { onPopulateSelectDone(data, 'selAgencia', 'id', 'nombre_com'); }),
                callWS("contactos", "getAnunciantes", '', function (data) { onPopulateSelectDone(data, 'selAnunciante', 'id', 'nombre_com'); }),
                callWS("productos", "getAll", '', function (data) { onPopulateSelectDone(data, 'selProducto', 'id_producto', 'desc_producto'); }),
                callWS("contactos", "getEjecutivos", '', function (data) { onPopulateSelectDone(data, 'selEjecutivo', 'id', 'razonSocial'); }),
                callWS("forma_pagos", "getAll", '', function (data) { onPopulateSelectDone(data, 'selFPago', 'id_formapago', 'desc_formapago'); }),
                callWS("medios", "getAllPlazos", '', function (data) { onPopulateSelectDone(data, 'selPlazoP', 'id_condpagoap', 'desc_condpagoap'); }),
                callWS("medios", "getAllMonedas", '', function (data) { onPopulateSelectMoneda(data, 'selMoneda'); }),
                callWS("medios", "getAllConceptos", '', function (data) { onPopulateSelectDone(data, 'selConceptoN', 'id_concepto_negocio', 'desc_concepto_negocio'); }),
            ).then(function () { checkParameters(); });
        }


        function onTarifaDSelected() {
            if (!$("#checkTarifaManualD").is(":checked")) {
                var imp_tarifa = $('#selTarifaD').children("option:selected").attr("precio_unitario");
                var cambio = $('#selTarifaD').children("option:selected").attr("cambio");
                $('#precioUnitarioD').val(imp_tarifa / cambio);
                calcularNetoD();
            }
        }


        var getUrlParameter = function getUrlParameter(sParam) {
            var sPageURL = window.location.search.substring(1),
                sURLVariables = sPageURL.split('&'),
                sParameterName,
                i;

            for (i = 0; i < sURLVariables.length; i++) {
                sParameterName = sURLVariables[i].split('=');

                if (sParameterName[0] === sParam) {
                    return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
                }
            }
        };


        function checkParameters() {
            var presup = getUrlParameter("presupId")
            var data = {};
            data.Id_presup = presup;
            if (presup != undefined) {
                callWS("orden_presup_aps", "getById", JSON.stringify(data), onGetPresup);
            }
        }


        function onGetPresup(data) {
            $('#fechaDesde').datetimepicker('date', moment(dateToFieldFormat(data.fecha), 'DD/MM/YYYY'));
            $('#fechaHasta').datetimepicker('date', moment(dateToFieldFormat(data.fecha_expiracion), 'DD/MM/YYYY'));

            $("#inpOrderMonth").val(data.mes);
            $("#inpOrderYear").val(data.anio);
            $("#inpOrderNumber").val(data.nro_presup);
            $("#inpOrderNumber").attr("id_op_dg", data.id_presup);

            $("#inpFechaAlta").val(dateToFieldFormat(data.fecha_alta));

            switch (data.id_estado) {
                case 0:
                    $("#inpEstado").val("En Proceso");
                    $("#inpEstado").css("color", "#dfdf99");

                    $("#bAceptarPresup").attr("disabled", true);
                    $("#bRechazarPresup").attr("disabled", true);
                    break;
                case 1:
                    $("#inpEstado").val("Pendiente");
                    $("#inpEstado").css("color", "#05baa4");
                    break;
                case 2:
                    $("#inpEstado").val("Aprobado Sin Vincular");
                    $("#inpEstado").css("color", "#c0dcc0");

                    $("#bAceptarPresup").attr("disabled", true);
                    $("#bRechazarPresup").attr("disabled", true);
                    break;
                case 3:
                    $("#inpEstado").val("Aprobado Vinculado");
                    $("#inpEstado").css("color", "#0f9013");

                    $("#bAceptarPresup").attr("disabled", true);
                    $("#bRechazarPresup").attr("disabled", true);
                    break;
                case 4:
                    $("#inpEstado").val("Rechazado");
                    $("#inpEstado").css("color", "#ff9897");

                    $("#bAceptarPresup").attr("disabled", true);
                    $("#bRechazarPresup").attr("disabled", true);
                    break;
                case 5:
                    $("#inpEstado").val("Rechazado Cerrado");
                    $("#inpEstado").css("color", "#c82626");

                    $("#bAceptarPresup").attr("disabled", true);
                    $("#bRechazarPresup").attr("disabled", true);
                    break;
            }

            if (data.id_moneda != null) {
                $("#selMoneda option[value=" + data.id_moneda + "]").attr("selected", "selected");
            }

            $("#selFacturar option[value=" + data.facturar_a + "]").attr("selected", "selected");

            if (data.agencia != null) {
                $("#selAgencia option[value=" + data.agencia.id_contacto + "]").attr("selected", "selected");
                cargarProductos(data.anunciante.id_contacto, data.producto.id_producto);
            }

            $("#selAnunciante option[value=" + data.anunciante.id_contacto + "]").attr("selected", "selected");
            $("#selAnunciante").change(); //para que cargue los productos

            $("#inpDescOP").val(data.descripcion);

            if (data.id_condpagoap != null) {
                $("#selPlazoP option[value=" + data.id_condpagoap + "]").attr("selected", "selected");
            }

            if (data.id_ejecutivo != null) {
                $("#selEjecutivo option[value=" + data.id_ejecutivo + "]").attr("selected", "selected");
            }

            var formasPago = data.formasPago;
            var viewListformasPago = "<ul class=\"list-group\">"
            if (formasPago != undefined) {
                if (formasPago.length > 0) {
                    var porcHTML = '';
                    formasPago.forEach(function (fPago) {
                        $("#selFPago option[value=" + fPago.id_formapago + "]").attr("selected", "selected");
                        var desc = $("#selFPago option[value=" + fPago.id_formapago + "]").text();
                        porcHTML += "<tr id='ronRow_" + fPago.id_formapago + "'><td>" + desc + "</td>" + "<td><input type='number' disabled='true' class='form-control inpRon' id='inpRonRow_" + fPago.id_formapago + "' value='" + fPago.porcentaje + "' onchange=\"$(this).attr('value',$(this).val())\" /></td></tr>"
                    });
                    $("#porcRon").html(porcHTML);
                    enableRon();
                }
                else {
                    viewListMedios += "<li class=\"list-group-item\">(Todos)</li>";
                }
            }
            viewListformasPago += "</ul>"
            $("#selFPago").after(viewListformasPago);
            cMultiSelect.bootstrapDualListbox('refresh');

            $("#selConceptoN option[value=" + data.id_concepto_negocio + "]").attr("selected", "selected");

            if (data.facturar_a == 2) {
                $("#selAgencia option[value=" + data.agencia.id_contacto + "]").attr("selected", "selected");
            }

            Detalles = data.detalles;

            $("#montoBruto").val(data.monto_bruto);
            $("#neto1").val(data.primer_neto);
            $("#neto2").val(data.seg_neto);
            $("#conf_nc").val(data.imp_conf_nc);
            $("#conf_fc").val(data.imp_conf_fc);
            // $("#total").val(data.tercer_neto); //Total

            $("#TableRenglones").empty();
            if (Detalles.length > 0) {
                $("#selAnunciante").attr("disabled", true);
                $("#botLimpiar").attr("disabled", true);
                $("#botLimpiar").attr("title", "No es posible limpiar Anunciante si existen Detalles cargados");
            }

            Detalles.forEach(generarTablaDetalles);

            //getArchivos(data.id_op_dg.toString());
            calculateTotals();
        }


        function cargarProductos(idAnunciante, idProducto) {
            $.when(
                callWS("productos", "getProductosPorAnunciante", idAnunciante.toString(), function (data) { onPopulateSelectDone(data, 'selProducto', 'id_producto', 'desc_producto'); })
            ).then(function () { onCargarProductos(idProducto) });
        }


        function onCargarProductos(idProducto) {
            $("#selProducto option[value=" + idProducto + "]").attr("selected", "selected");
        }


        function savePresup(estado) {
            var data = {};

            if ($("#inpOrderNumber").val() != "") {
                data.nro_presup = $("#inpOrderNumber").val();
                data.id_presup = $("#inpOrderNumber").attr("id_op_dg")
            }
            data.anio = $("#inpOrderYear").val();
            data.mes = $("#inpOrderMonth").val();
            data.descripcion = $("#inpDescOP").val();
            data.agencia = {};
            data.agencia.Id_contacto = $("#selAgencia").val();
            data.agencia.Nombre_com = $("#selAgencia option:selected").text();
            data.anunciante = {};
            data.anunciante.Id_contacto = $("#selAnunciante").val();
            data.anunciante.Nombre_com = $("#selAnunciante option:selected").text();
            data.Facturar_a = $("#selFacturar").val();
            data.id_estado = estado;

            callWS("orden_presup_aps", "respuestaCliente", JSON.stringify(data), function (resultado) { onSavePresup(resultado, data); });
        }


        function onSavePresup(id_estado) {

            if (id_estado == 4) {
                $("#bAceptarPresup").attr("disabled", true);
                $("#bRechazarPresup").attr("disabled", true);
                $("#inpEstado").val("Rechazado");
                $("#inpEstado").css("color", "#ff9897");

                showMessage("El Presupuesto ha sido Rechazado");
            }
            else if (id_estado == 2) {
                $("#bAceptarPresup").attr("disabled", true);
                $("#bRechazarPresup").attr("disabled", true);
                $("#inpEstado").val("Aprobado Sin Vincular");
                $("#inpEstado").css("color", "#c0dcc0");

                showMessage("El Presupuesto ha sido Aceptado");
            }
            else {
                showMessage("Ocurrió un error al intentar Aceptar/Rechazar Presupuesto", "error");
            }
        }


        function dateToSqlFormat(date) {
            arr = date.split("/");
            sqlFormatDate = '';
            sqlFormatDate = arr[2] + '-' + arr[1] + '-' + arr[0];
            return sqlFormatDate;
        }


        function dateToFieldFormat(date) {
            date = date.split('T')[0];
            arr = date.split("-");
            fieldFormatDate = '';
            fieldFormatDate = arr[2] + '/' + arr[1] + '/' + arr[0];
            return fieldFormatDate;
        }


        function datetimeToTime(datetime) {
            var time = datetime.split('T')[1];
            arr = time.split(":");
            fieldFormatTime = '';
            fieldFormatTime = arr[0] + ':' + arr[1];
            return fieldFormatTime;
        }


        function calculateTotals() {

            var sumNetoRenglones = 0;
            var sumBrutoRenglones = 0;
            var sumNCRenglones = 0;
            var sumFCRenglones = 0;
            var neto2 = 0;
            Detalles.forEach(function (item, index) {
                sumNetoRenglones += parseFloat(item.monto_neto);
                sumBrutoRenglones += parseFloat(item.monto_bruto);
                sumNCRenglones += item.impconfnc;
                sumFCRenglones += item.impconffc;
            })
            $("#montoBruto").val(sumBrutoRenglones.toFixed(2));

            if (sumBrutoRenglones != 0) {
                $("#porc_desc").val((100 - 100 * (sumNetoRenglones / sumBrutoRenglones)).toFixed(2));
            } else {
                $("#porc_desc").val(0);
            }

            $("#conf_nc").val(sumNCRenglones);
            $("#conf_fc").val(sumFCRenglones);

            $("#neto1").val(sumNetoRenglones);

            neto2 = sumNetoRenglones - sumNCRenglones - sumFCRenglones;
            $("#neto2").val(neto2.toFixed(2));
            //cTotal = neto2 * 1.21; CON IVA
            cTotal = neto2;

            $("#total").val(cTotal.toFixed(2));
        }


        function onAnuncianteSelected() {
            data = {};

            an = $('#selAnunciante').val();
            if (an == null) {
                return -1;
            }
            ag = $('#selAgencia').val();

            if (ag != null) {
                data.agencia = {};
                data.anunciante = {};
                data.anunciante.id = an;
                data.agencia.id = ag;

                callWS("contactos", "getAgenciasPorAnunciante", an, function (data) { onPopulateSelectDone(data, 'selAgencia', 'id', 'nombre_com'); });
            } else {
                callWS("contactos", "getAgenciasPorAnunciante", an, function (data) { onPopulateSelectDone(data, 'selAgencia', 'id', 'nombre_com'); });
            }

            callWS("productos", "getProductosPorAnunciante", an, function (data) { onPopulateSelectDone(data, 'selProducto', 'id_producto', 'desc_producto'); });
        }


        function onAgenciaSelected() {
            an = $('#selAnunciante').val();
            ag = $('#selAgencia').val();
            if (an == null) {
                $('#selProductoD').empty();
                $('#selProducto').empty();
                callWS("contactos", "getAnunciantesPorAgencia", ag, function (data) { onPopulateSelectDone(data, 'selAnunciante', 'id', 'nombre_com'); });
            } else {
                data.agencia = {};
                data.anunciante = {};
                data.anunciante.id = an;
                data.agencia.id = ag;

                callWS("contactos", "getAnunciantesPorAgencia", ag, function (data) { onPopulateSelectDone(data, 'selAnunciante', 'id', 'nombre_com'); });
            }
        }


        function onProductoSelected() {
            an = $('#selAnunciante').val();
            ag = $('#selAgencia').val();
            pr = $('#selProducto').val();
            if (ag == null && an == null) {
                callWS("contactos", "getAnunciantesPorProducto", pr, function (data) { onPopulateSelectDone(data, 'selAnunciante', 'id', 'nombre_com'); });
            }
        }


        function onTipoAvisoGetAll(data, idSelect) {
            var pObj = data;
            var listitems = '';
            $.each(pObj, function (it, iObj) {
                listitems += '<option value=' + iObj['id_categoria'] + '>' + iObj["descripcion"] + '</option>';
            });
            $("#" + idSelect).empty();
            $("#" + idSelect).append(listitems);
            if (pObj.length > 1) {
                $("#" + idSelect).val([]);
            }
        }


        function onTipoAvisoGetAll2(data, rDetalle, idSelect) {
            var pObj = data;
            var listitems = '';
            $.each(pObj, function (it, iObj) {
                listitems += '<option value=' + iObj['id_categoria'] + '>' + iObj["descripcion"] + '</option>';
            });
            $("#" + idSelect).empty();
            $("#" + idSelect).append(listitems);
            if (pObj.length > 1) {
                $("#" + idSelect).val([]);
            }

            seleccionarCamposRestantes(rDetalle);
        }


        function onTarifasGetAll(data, idSelect, colId, colDesc) {
            var pObj = data;
            var listitems = '';
            $.each(pObj, function (it, iObj) {
                listitems += '<option forma_uso_desc=' + iObj['forma_uso']['desc_tarifa'] + ' forma_uso_id=' + iObj['forma_uso']['id_tarifa'] + ' precio_unitario= ' + iObj['importe_tarifa'] + ' cambio= ' + iObj['cambio'] + ' hs_desde= ' + iObj['hs_desde'] + ' hs_hasta= ' + iObj['hs_hasta'] + ' value=' + iObj[colId] + '>' + iObj[colDesc] + '</option>';
            });
            $("#" + idSelect).empty();
            $("#" + idSelect).append(listitems);
            $("#" + idSelect).val([]);
        }


        function onTarifasGetAll2(data, rDetalle, idSelect, colId, colDesc) {
            var pObj = data;
            var listitems = '';
            $.each(pObj, function (it, iObj) {
                listitems += '<option forma_uso_desc=' + iObj['forma_uso']['desc_tarifa'] + ' forma_uso_id=' + iObj['forma_uso']['id_tarifa'] + ' precio_unitario= ' + iObj['importe_tarifa'] + ' cambio= ' + iObj['cambio'] + ' hs_desde= ' + iObj['hs_desde'] + ' hs_hasta= ' + iObj['hs_hasta'] + ' value=' + iObj[colId] + '>' + iObj[colDesc] + '</option>';
            });
            $("#" + idSelect).empty();
            $("#" + idSelect).append(listitems);
            $("#" + idSelect).val([]);

            $.when($("#selTarifaD option[value=" + rDetalle.id_tarifa + "]").attr("selected", "selected")).then(
                filterPorTarifa(rDetalle)
            )
        }


        function onPopulateSelectDone(data, idSelect, colId, colDesc) {

            var sel = document.getElementById(idSelect);
            var selected = sel.options[sel.selectedIndex];

            var pObj = data;
            if (idSelect == "selTipoTarifaD") {
                listitems = '<option value= -1 ></option>';
            }
            else {
                var listitems = '';
            }
            $.each(pObj, function (it, iObj) {
                listitems += '<option value=' + iObj[colId] + '>' + iObj[colDesc] + '</option>';
            });
            $("#" + idSelect).empty();
            $("#" + idSelect).append(listitems);
            if (pObj.length > 1) {
                $("#" + idSelect).val([]);
            } else {
                if (idSelect == "selAnunciante") {
                    $("#selAnunciante").change();//Carga los productos
                }
            }
            if (idSelect == "selPrograma") {
                $("#" + idSelect).prepend("<option value=''></option>");
            }

            if ((idSelect == "selAnunciante" || idSelect == "selAgencia" || idSelect == "selProducto") && selected != undefined) {
                //Carga las opciones filtradas pero deja seleccionada la que estaba
                $("#" + idSelect).val(selected.value);
            }

            if ($("#" + idSelect).attr('multiple') == 'multiple') {
                cMultiSelect.bootstrapDualListbox('refresh');
            }

            if (idSelect == 'selFPago') {
                enableRon();
            }
        }


        function onPopulateSelectMoneda(data, idSelect) {
            var pObj = data;
            var listitems = '';
            $.each(pObj, function (it, iObj) {
                if (iObj.base == true) {
                    listitems += '<option cambio=' + iObj['cambioCompra'] + ' value=' + iObj['id_moneda'] + ' selected>' + iObj["nombre"] + " (" + iObj["simbolo"] + ')</option>';
                }
                else {
                    listitems += '<option cambio=' + iObj['cambioCompra'] + ' value=' + iObj['id_moneda'] + '>' + iObj["nombre"] + " (" + iObj["simbolo"] + ')</option>';
                }
            });
            $("#" + idSelect).empty();
            $("#" + idSelect).append(listitems);

            callWS("medios", "getParamById", JSON.stringify(5), function (parMulti) { onCheckMultimoneda(parMulti); });
        }


        function onCheckMultimoneda(param) {
            if (param.valor == 0) {
                $("#selMoneda").attr("disabled", true);
                $("#bCambioMoneda").attr("disabled", true);
            }
        }


        function filterTarifas(rDetalle) {
            bloquearCamposDetalle();

            var error = [];
            var day1;
            var day2;
            if ($('#fechaDesde').val() != "") {
                fDesde = new Date(moment($("#fechaDesde").val(), 'DD/MM/YYYY', true).format());
                mfDesde = moment(fDesde);
                if (mfDesde.isValid()) {
                    day1 = new Date(dateToSqlFormat($('#fechaDesde').val()));
                } else {
                    error.push("Formato 'Fecha Desde' invalido");
                    return error;
                }
            }
            if ($('#fechaHasta').val() != "") {
                fHasta = new Date(moment($("#fechaHasta").val(), 'DD/MM/YYYY', true).format());
                mfHasta = moment(fHasta);
                if (mfHasta.isValid()) {
                    var day2 = new Date(dateToSqlFormat($('#fechaHasta').val()));
                } else {
                    error.push("Formato 'Fecha Hasta' invalido");
                    return error;
                }
            }

            var parametros = {};
            var listaParametros = [];

            var objParametro = {};
            objParametro.ParameterName = "fecha_desde";
            objParametro.Value = day1;
            listaParametros.push(objParametro);

            var objParametro = {};
            objParametro.ParameterName = "fecha_hasta";
            if (day2 == undefined) {
                day2 = "";
            }
            objParametro.Value = day2;
            listaParametros.push(objParametro);

            if ($('#selMediosD').val() != null) {
                objParametro = {};
                objParametro.ParameterName = "id_medio";
                objParametro.Value = $('#selMediosD').val();
                listaParametros.push(objParametro);
            }

            //if ($('#selMoneda').val() != null) {
            //    objParametro = {};
            //    objParametro.ParameterName = "id_moneda";
            //    objParametro.Value = $("#selMoneda").val();
            //    listaParametros.push(objParametro);
            //}

            objParametro = {};
            objParametro.ParameterName = "vigente";
            objParametro.Value = 1;
            listaParametros.push(objParametro);

            parametros.Parametros = listaParametros;

            if (rDetalle != undefined) {
                callWS("tarifas", "filterTrafico", JSON.stringify(parametros), function (data) { onTarifasGetAll2(data, rDetalle, 'selTarifaD', 'id_tarifa', 'desc_tarifa'); });
            }
            else {
                callWS("tarifas", "filterTrafico", JSON.stringify(parametros), function (data) { onTarifasGetAll(data, 'selTarifaD', 'id_tarifa', 'desc_tarifa'); });
            }
        }


        function filterProgramas(selected = 0) {
            if ($("#selMediosD").val() != null) {
                listaMedios = "";
                listaMedios = $("#selMediosD").val();

                $.when(callWS("programa", "getAllProgramasMedio", JSON.stringify(listaMedios), function (data) { onPopulateSelectDone(data, 'selPrograma', 'id_programa', 'desc_programa') }))
                    .then(function () {
                        if (selected != 0) {
                            $("#selPrograma option[value=" + selected + "]").attr("selected", "selected");
                        }
                    })
            } else {
                $("#selPrograma").empty();
            }
        }


        function filterPorTarifa(rDetalle) {
            if ($("#selTarifaD").val() != "" && $("#selTarifaD").val() != null) {
                onTarifaDSelected();
                var tarifa = {};
                tarifa.Id_tarifa = $("#selTarifaD").val();

                //buscar tarifa por ID
                $.when(callWS("tarifas", "getFormasUsoAllTrafico", '', function (data) { onPopulateSelectDone(data, 'selTipoTarifaD', 'id', 'descripcion'); })).then(function () {
                    callWS("tarifas", "getByIdTrafico", JSON.stringify(tarifa), function (data) { onFilterPorTarifa(data, rDetalle); });
                });
            }
        }


        function onFilterPorTarifa(tarifa, rDetalle) {
            //limitar las fechas de vigencia con las fvigen_desde y fvigen_hasta que trae la tarifa
            $.when(formatearDatetimepickers(tarifa.fvigen_desde, tarifa.fvigen_hasta)).then(function () {
                $('#fechaDesdeD').datetimepicker('date', moment($("#fechaDesde").val(), 'DD/MM/YYYY'));
                $('#fechaHastaD').datetimepicker('date', moment($("#fechaHasta").val(), 'DD/MM/YYYY'));
            });

            //cargar forma de uso con el forma_uso que trae
            $("#selTipoTarifaD").val(tarifa.forma_uso.id);

            //cargar tipo de aviso con el id_categoria que trae
            if (tarifa.id_categoria > 0) {
                var tipoAviso = {};
                tipoAviso.id_categoria = tarifa.id_categoria;
                callWS("tipos_avisos", "getById", JSON.stringify(tipoAviso), function (data) { onGetTipoAviso(data, rDetalle); });
            }
            else {
                if (rDetalle != undefined) {
                    callWS("Tipos_avisos", "getAll", '', function (data) { onTipoAvisoGetAll2(data, rDetalle, 'selTipoAvisoD'); });
                }
                else {
                    callWS("Tipos_avisos", "getAll", '', function (data) { onTipoAvisoGetAll(data, 'selTipoAvisoD'); });
                }
            }
        }


        function onGetTipoAviso(tipoAviso, rDetalle) {
            var tiposAvisos = {}
            tiposAvisos.push(tipoAviso);
            if (rDetalle != undefined) {
                onTipoAvisoGetAll2(tiposAvisos, rDetalle, 'selTipoAvisoD');
            }
            else {
                onTipoAvisoGetAll(tiposAvisos, 'selTipoAvisoD');
            }
        }


        function formatearDatetimepickers(fDesde, fHasta) {
            var desde = new Date(fDesde);
            var hasta = new Date(fHasta);

            $('#fechaDesdeD').datetimepicker({ format: 'L', locale: 'es', minDate: desde });
            $('#fechaHastaD').datetimepicker({ format: 'L', locale: 'es', maxDate: hasta });
        }


        function setListaParametros(data) {
            var parametros = {};
            var listaParametros = [];

            Object.keys(data).forEach(function (key) {
                var objParametro = {};
                objParametro.ParameterName = key;
                objParametro.Value = data[key];
                listaParametros.push(objParametro);
            });
            parametros.Parametros = listaParametros;
            return parametros;
        }


        //Parametro global para llevar los detalles
        Detalles = [];


        function generarTablaDetalles(det, index) {
            id = det.id_detalle;

            var str = "<tr  id='row" + id + "' data-id='row" + id + "' idAnunciante='" + $("#selAnunciante").val() + "'>";

            if (det.desc_programa == "") {
                str = str + "<td class='col-xs-3' > - / " + datetimeToTime(det.hs_desde) + " - " + datetimeToTime(det.hs_hasta) + "</td > ";
            }
            else {
                str = str + "<td class='col-xs-3' > " + det.desc_programa + " / " + datetimeToTime(det.hs_desde) + " - " + datetimeToTime(det.hs_hasta) + "</td > ";
            }
            if (det.fecha_hasta == null) {
                str = str + "<td  class='col-xs-2' dataid='" + id + "'>" + dateToFieldFormat(det.fecha_desde) + " - Por definir </td>";
            }
            else {
                str = str + "<td  class='col-xs-2' dataid='" + id + "'>" + dateToFieldFormat(det.fecha_desde) + " - " + dateToFieldFormat(det.fecha_hasta) + "</td>";
            }
            str = str + " <td class='col-xs-2' dataid = '" + det.id_categoria + "' > " + det.desc_categoria + "</td > ";
            if (det.id_tarifa == "" || det.id_tarifa == undefined || det.id_tarifa == null) {
                str = str + "<td class='col-xs-1'> Custom </td>";
            }
            else {
                str = str + "<td class='col-xs-1' dataid = '" + det.id_tarifa + "' > " + det.desc_tarifa + "</td>";
            }
            str = str + "<td class='col-xs-1'>" + det.cantidad + "</td>";
            str = str + "<td class='col-xs-1'>" + det.monto_neto + "</td>";
            str = str + "<td class='col-xs-2 pr-0 actions d-flex justify-content-center align-content-start'>";

            $('.disableOnEdit').attr("disabled", false);

            //  Botón ver renglon
            str = str + " <button type='button' data-id='" + id + "' class='btn actions btn-outline-dark btn-sm mr-1'  onclick='cargarModificarRenglon(this)' title='Ver Detalle'> <span class='fa fa-eye'></span></button>";

            str = str + "</td>";

            $("#TableRenglones").append(str);
        }


        function calcularNetoD() {

            cantD = $("#cantidadD").val();
            descD = $("#descuentoD").val();
            resultD = $("#precioUnitarioD").val();

            if ($('#selTipoTarifaD').val() == 1) {
                var day1 = new Date(dateToSqlFormat($('#fechaDesdeD').val()));
                var day2 = new Date(dateToSqlFormat($('#fechaHastaD').val()));

                var difference = Math.abs(day2 - day1);
                cantD = (difference / (1000 * 3600 * 24)) + 1;

                $("#cantidadD").val(cantD);

                if (descD == "") {
                    descD = 0;
                }
                if (resultD == "" || resultD < 0) {
                    $("#resultD").val("");
                    $("#totalD").val("");
                    return;
                }
                if (cantD == "" || cantD <= 0) {
                    $("#cantidadD").val("");
                    $("#totalD").val("");
                    return;
                }
            }

            brutoD = resultD * cantD;

            resultD = brutoD - (brutoD * descD / 100);

            $("#totalD").val(resultD.toFixed(2));
        }


        function cargarModificarRenglon(r) {
            $('#pTituloDetalle').text('EDITAR DETALLE')
            $("#divClonDet").empty();

            if ($("#fechaHasta").val() == "" || $("#fechaDesde").val() == "") {
                showMessage("Debe seleccionar la vigencia de la orden", "info");
                return 0;
            }
            if ($("#selAgencia").val() == null) {
                showMessage("Seleccione una Agencia", "info");
                return 0;
            }
            if ($("#selAnunciante").val() == null) {
                showMessage("Seleccione un Anunciante", "info");
                return 0;
            }
            if ($("#selProducto").val() == null) {
                showMessage("Seleccione un Producto", "info");
                return 0;
            }
            if ($("#selConceptoN").val() == null) {
                showMessage("Seleccione un Concepto de Negocio", "info");
                return 0;
            }
            if ($("#selFPago").val().length == 0) {
                showMessage("Seleccione un Tipo de Venta", "info");
                return 0;
            }
            if ($("#selPlazoP").val() == null) {
                showMessage("Seleccione un Plazo de Pago", "info");
                return 0;
            }
            if ($("#selEjecutivo").val() == null || $("#selEjecutivo").val() == 0) {
                showMessage("Seleccione un Ejecutivo", "info");
                return 0;
            }

            $("#selAnunciante").attr("disabled", true);
            $('#divDetailsRows').hide(); $('#divAddRow').show();
            $("#checkTarifaManualD")[0].checked = false;
            $("#checkTarifaManualD").change();

            var rId = $(r).attr("data-id");

            var rDetalle = Detalles.find(detalle => detalle.id_detalle == rId);

            var parametros = {};
            var listaParametros = [];
            objParametro = {};
            objParametro.ParameterName = "id_medio";
            objParametro.Value = rDetalle.id_medio;
            listaParametros.push(objParametro);
            parametros.Parametros = listaParametros;

            $.when(
                callWS("medios", "getAll", '', function (data) { onPopulateSelectDone(data, 'selMediosD', 'id_medio', 'desc_medio'); })
            ).then(function () { onCargarModificarRenglon(rDetalle) }, function (data1, data2, data3) {
                console.log("Medios: " + data1[2].statusText + "; Formas de uso: " + data2[2].statusText + "Tipo Aviso: " + data3[2].statusText + ";");
                showMessage("Se produjo un error al cargar los campos, intentelo nuevamente", type = "alert");
            });
        }


        function onCargarModificarRenglon(rDetalle) {
            $("#GuardarRenglon").attr("onclick", "prevAddRenglon(" + rDetalle.id_detalle + ")");

            $.when($("#selMediosD option[value=" + rDetalle.id_medio + "]").attr("selected", "selected")).
                then(filterTarifas(rDetalle)
            )
        }


        function onCargarModificarRenglon2(rDetalle) {
            $.when($("#selTarifaD option[value=" + rDetalle.id_tarifa + "]").attr("selected", "selected")).then(
                $("#selTarifaD").change()
            ).then(
                seleccionarCamposRestantes(rDetalle)
            )
        }


        function wait(ms) {
            var start = new Date().getTime();
            var end = start;
            while (end < start + ms) {
                end = new Date().getTime();
            }
        }


        function seleccionarCamposRestantes(rDetalle) {
            //Carga Fechas
            $('#fechaDesdeD').datetimepicker('date', moment(dateToFieldFormat(rDetalle.fecha_desde), 'DD/MM/YYYY'));

            if (rDetalle.fecha_hasta == null) {
                $('#fechaHastaD').datetimepicker('date', null);
            }
            else {
                $('#fechaHastaD').datetimepicker('date', moment(dateToFieldFormat(rDetalle.fecha_hasta), 'DD/MM/YYYY'));
            }

            //Carga Programas
            filterProgramas(rDetalle.id_programa);

            //Carga Forme de uso
            $("#selTipoTarifaD option[value=" + rDetalle.formausotarifa + "]").attr("selected", "selected");

            //Carga Tipo Aviso
            if (rDetalle.id_categoria != null) {
                $("#selTipoAvisoD option[value=" + rDetalle.id_categoria + "]").attr("selected", "selected");
            }

            //Carga Rango horarios
            $('#rangoDesde').val(datetimeToTime(rDetalle.hs_desde));
            $('#rangoHasta').val(datetimeToTime(rDetalle.hs_hasta));

            //Carga otros datos
            $('#selAmbito').val(rDetalle.ambitoTar);
            $('#precioUnitarioD').val(rDetalle.imp_tarifa);
            if (rDetalle.cantidad == -1) {
                $('#cantidadD').val(0);
            }
            else {
                $('#cantidadD').val(rDetalle.cantidad);
            }
            $('#descuentoD').val(rDetalle.porc_dto);
            $('#totalD').val(rDetalle.monto_neto);
            $("#confNCD").val(rDetalle.porcconfnc);
            $("#confFCD").val(rDetalle.porcconffc);

            if (rDetalle.netomanual) {
                $("#checkTarifaManualD")[0].checked = true;
                $("#checkTarifaManualD").change();
                $("#precioUnitarioD").val(rDetalle.imp_tarifa);
                $("#precioUnitarioD").change();
            }
        }


        function selectToJson(idSelect, idCol) {
            ret = [];

            values = $('#' + idSelect).val();
            values.forEach(function (value) {
                item = {};
                item[idCol] = value;
                ret.push(item);
            });
            return ret;
        }


        function openRonPorc() {
            var modalHTML = '';
            modalHTML += "<div class='row justify-content-center'><table><thead></thead><tbody id='ronTableBody'>"
            var div = $("#porcRon");
            if (div[0].innerHTML == "") {
                formasPago = $("#selFPago option:selected");
                $.each(formasPago, function (index, fPago) {
                    modalHTML += "<tr id='ronRow_" + fPago.value + "'><td>" + fPago.text + "</td>" + "<td width='30%'><input type='number' class='form-control inpRon' id='inpRonRow_" + fPago.value + "' value='0' onchange=\"$(this).attr('value',$(this).val())\" /></td></tr>"
                })
            } else {
                modalHTML += div[0].innerHTML;
            }
            modalHTML += "</tbody></table></div>"
            modalFooter = "<button type='button' class='btn btn-secondary' data-dismiss='modal' onClick=\"$('#ronTableBody').empty();\"> Cerrar </button>";
            $("#modalRonBody").html(modalHTML);
            $("#modalRonFooter").html(modalFooter);
            $("#modalRon").modal('show');
        }


        function enableRon() {
            var selected = $("#selFPago option:selected").length;
            if (selected > 1) {
                $("#botPorcRon").attr("disabled", false);
            } else {
                $("#botPorcRon").attr("disabled", true);
            }
        }


        function round(value, decimals) {
            return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
        }


        function cancelarCargaDetalle() {
            $("#GuardarRenglon").attr("onclick", "prevAddRenglon(-1)");
            $('#divDetailsRows').show();
            $('#divAddRow').hide();
            //DetalleClon = false;

            if ($("#inpOrderNumber").attr("id_presup") == 0) {
                $("#selAnunciante").attr("disabled", false);
            }
        }


        function bloquearCamposDetalle() {
            $("#fechaDesdeD").attr("disabled", true);
            $("#fechaHastaD").attr("disabled", true);
            $("#selPrograma").attr("disabled", true);
            $("#selTipoAvisoD").attr("disabled", true);
            $("#selTarifaD").attr("disabled", true);
            $("#checkTarifaManualD").attr("disabled", true);
            $("#selAmbito").attr("disabled", true);
            $("#rangoDesde").attr("disabled", true);
            $("#rangoHasta").attr("disabled", true);
            $("#precioUnitarioD").attr("disabled", true);
            $("#cantidadD").attr("disabled", true);
            $("#descuentoD").attr("disabled", true);
            $("#confNCD").attr("disabled", true);
            $("#confFCD").attr("disabled", true);
            $("#GuardarRenglon").attr("disabled", true);
        }


        function bloquearCamposCabecera() {
            $("#inpOrderNumberClient").attr("disabled", true);
            $("#inpDescOP").attr("disabled", true);
            $("#fechaDesde").attr("disabled", true);
            $("#fechaHasta").attr("disabled", true);
            $("#selConceptoN").attr("disabled", true);
            $("#selAgencia").attr("disabled", true);
            $("#selProducto").attr("disabled", true);
            $("#selFacturar").attr("disabled", true);
            $("#selFPago").attr("disabled", true);
            $("#selPlazoP").attr("disabled", true);
            $("#selEjecutivo").attr("disabled", true);
            $("#selMoneda").attr("disabled", true);
            $("#bCargarNuevoRenglon").attr("disabled", true);
            $(".bootstrap-duallistbox-container").find("*").prop("disabled", true);
        }


        function formatearMonto(x) {
            return Number.parseFloat(x).toFixed(2);
        }


        function getCotizaciones() {
            callWS("medios", "getCotizaciones", "", function (data) { onPopulateTableCotizaciones(data); });
        }


        function onPopulateTableCotizaciones(data) {
            rowHTML = ''

            $.each(data, function (it, cotizacion) {

                rowHTML += "<tr>";
                rowHTML += "<td class='col-xs-1' style='text-align: center;'> " + cotizacion.nombre + " (" + cotizacion.simbolo + ")</td > ";
                rowHTML += "<td class='col-xs-1' style='text-align: center;'> " + cotizacion.cambioCompra + "</td >";
            /*  rowHTML += "<td class='col-xs-1' style='text-align: center;'> " + cotizacion.cambioVenta + "</td >";*/
                rowHTML += "<td class='col-xs-1' style='text-align: center;'> " + dateToFieldFormat(cotizacion.fecha) + "</td >";
                rowHTML += "</tr>";

            });

            $("#TableCotizaciones").html(rowHTML);

            $("#cotizacionModal").modal('show');
        }

    </script>
    <footer>
        <p style="text-align: center; font-size: x-small;">Powered by <b style="font-size: small;">Strategy Zone S.A. ©</b></p>
    </footer>
</body>
</html>